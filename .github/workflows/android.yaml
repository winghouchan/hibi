name: android

on:
  workflow_call:
    inputs:
      test-shards:
        required: true
        type: string

permissions:
  actions: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      architecture: x86_64
      artifact-name: build-android

    outputs:
      architecture: ${{ env.architecture }}
      artifact-name: ${{ env.artifact-name }}

    steps:
      - name: ðŸ‘€ Checkout
        uses: actions/checkout@v4

      - name: âš¡ï¸ Set up build cache
        id: build-cache
        uses: ./.github/actions/set-up-ccache

      - name: ðŸ—ï¸ Set up Android NDK
        id: set-up-android-ndk
        uses: ./.github/actions/set-up-android-ndk

      - name: ðŸ—ï¸ Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version-file: '.tool-versions'

      - name: ðŸ—ï¸ Set up Node.js
        uses: ./.github/actions/set-up-node-js

      - name: ðŸšš Install Node modules
        uses: ./.github/actions/install-node-modules

      - name: ðŸŒ Compile message catalogs
        run: |
          yarn run build:intl:extract-template
          yarn run build:intl:compile

      - name: ðŸ§° Prepare build
        run: yarn run expo prebuild --platform android

      # The Gradle setup action restores a cache of various Gradle files into
      # the `android/.gradle` directory. The `android` directory is generated
      # by `expo prebuild`. As a result, the Gradle setup has to happen after
      # `expo prebuild` has been run.
      - name: ðŸ—ï¸ Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}

      # Built Gradle plugins need to exist to ensure a Gradle configuration
      # cache hit. The cache restores files into `node_modules` so needs can
      # only be run after Node modules have been installed/restored.
      - name: âš¡ï¸ Set up Gradle plugins
        uses: actions/cache@v4
        with:
          key: gradle-plugins-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('**/*gradle-plugin/**/src') }}
          path: '**/*gradle-plugin/**/build'

      # React Native generates some files during [auto-linking][1]:
      #
      # - `autolinking.json`: A file with some information about dependencies
      #    that are auto-linked.
      # - `package.json.sha`: A hash of the `package.json`, to help indicate if
      #    the auto-linking information is out of date.
      # - `yarn.lock.sha`: A hash of the `yarn.lock`, to help indicate if the
      #    auto-linking information is out of date.
      #
      # This part of auto-linking is performed in the `settings.gradle`, see
      # calls to the `ex.autolinkLibrariesFromCommand` function. This, however,
      # causes a problem when used in combination with the Gradle configuration
      # cache in CI:
      #
      # 1. After `expo prebuild` has been run, the contents of the above files
      #    is just a template. Auto-linking has not populated those files with
      #    project-relevant data yet.
      # 2. Once the build command is executed, calling Gradle assemble tasks,
      #    `settings.gradle` is run, performing this part of the auto-linking
      #    process. The state of the above files, before auto-linking, is
      #    captured as inputs to the Gradle configuration cache.
      # 3. In subsequent runs, there may be a Gradle configuration cache hit,
      #    which stops `settings.gradle` from being run. This results in auto-
      #    linking not being performed, causing runtime errors.
      #
      # To solve this problem, this step generates those files. The method has
      # been determined by reading the [source][2] of the Gradle plugin that
      # does this.
      #
      # yamllint disable rule:line-length
      # [1]: https://docs.expo.dev/modules/autolinking/
      # [2]: https://github.com/facebook/react-native/blob/b75031f3ddeb2034e219d0ec541914ccdc2b2c8c/packages/gradle-plugin/settings-plugin/src/main/kotlin/com/facebook/react/ReactSettingsExtension.kt
      # yamllint enable rule:line-length
      - name: ðŸ”— Link native dependencies
        run: |
          # Gather native module information, strip ANSI escape sequences, convert to JSON and write to file
          yarn run expo-modules-autolinking react-native-config --platform android |
            sed 's/\x1B\[[0-9;]\{1,\}[A-Za-z]//g' |
            node -p 'JSON.stringify(eval(`(${require("fs").readFileSync(0, "utf8")})`))' \
            > android/build/generated/autolinking/autolinking.json

          # Hash `package.json`. `sha256sum` outputs in the format `<hash> <file name>\n` so the hash must be extracted.
          echo -n $(sha256sum package.json | awk '{print $1}') > android/build/generated/autolinking/package.json.sha

          # Hash `yarn.lock`. `sha256sum` outputs in the format `<hash> <file name>\n` so the hash must be extracted.
          echo -n $(sha256sum yarn.lock | awk '{print $1}') > android/build/generated/autolinking/yarn.lock.sha

      # Build the Android test APK with the specified architecture and increased
      # JVM memory to avoid out-of-memory errors.
      #
      # A debug build is built because the end-to-end tests executes `run-as` in
      # the ADB shell to write fixture data, which is only possible with debug
      # builds.
      - name: ðŸ‘· Build app
        id: build
        run: |
          ndk_version=$(yarn run build:android:test:debug \
            :properties --property ndkVersion \
            -Dorg.gradle.jvmargs='-Xmx4g -XX:MaxMetaspaceSize=1g' \
            -PreactNativeArchitectures='${{ env.architecture }}' |
          tee >(cat >&2) |
          sed -En 's/ndkVersion: ([0-9]+\.[0-9]+\.[0-9]+)/\1/Ip')

          echo "ndk_version=$ndk_version" >> $GITHUB_OUTPUT

      - name: ðŸ’¾ Save app build
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.artifact-name }}
          path: ./android/app/build/outputs/apk/endToEndTest/debug/app-endToEndTest-debug.apk
          if-no-files-found: 'error'

      - name: ðŸ’¾ Save build cache debug artifacts
        if: runner.debug
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.artifact-name }}-build-cache-debug-artifacts
          path: ${{ steps.build-cache.outputs.debug-directory }}

      - name: âš¡ï¸ Cache Android NDK
        if: steps.set-up-android-ndk.outputs.version != steps.build.outputs.ndk_version
        uses: actions/cache/save@v4
        with:
          key: android-ndk-${{ steps.build.outputs.ndk_version }}
          path: /usr/local/lib/android/sdk/ndk/${{ steps.build.outputs.ndk_version }}*

  test:
    needs: [build]
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      app-directory: ./build
      app-name: app-endToEndTest-debug.apk
      emulator-log-location: ./emulator.log

    strategy:
      # Allow other shards to run to completion to allow for the possibility of
      # them passing, reducing the amount of shards that need to be re-run.
      fail-fast: false
      matrix:
        shard: ${{ fromJson(inputs.test-shards) }}

    steps:
      - name: ðŸ‘€ Checkout
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: '.tool-versions'

      - name: ðŸ—ï¸ Set up Node.js
        uses: ./.github/actions/set-up-node-js

      - name: ðŸ—ï¸ Set up Maestro
        uses: ./.github/actions/set-up-maestro

      - name: ðŸšš Install Node modules
        uses: ./.github/actions/install-node-modules

      - name: ðŸ“¥ Download app build
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: ${{ env.app-directory }}

      - name: ðŸŒ Compile message catalogs
        run: |
          yarn run build:intl:extract-template
          yarn run build:intl:compile

      # Speeds up tests
      #
      # yamllint disable rule:line-length
      # See: https://github.com/ReactiveCircus/android-emulator-runner/blob/b68ca169d637f9b4902ca0bcd9ff339a105e5518/README.md?plain=1#L13-L23
      # Hardware acceleration is available on larger (4-core runners): https://github.blog/changelog/2023-02-23-hardware-accelerated-android-virtualization-on-actions-windows-and-linux-larger-hosted-runners/
      # 4-core runners are available for open source repositories:  https://github.blog/news-insights/product-news/github-hosted-runners-double-the-power-for-open-source/
      # yamllint enable rule:line-length
      - name: ðŸŽï¸ Enable hardware acceleration
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: ðŸ—„ï¸ Start JavaScript bundle server
        env:
          EXPO_PUBLIC_TELEMETRY_DSN: http://spotlight@localhost:8969/0
        run: |
          # Start the JavaScript bundle server in the background and wait for it
          # to be ready ("waiting on" logged) before allowing the run to continue
          nohup yarn start:test > nohup.out 2>&1 & while ! test -f nohup.out; do :; done && tail -F nohup.out | grep -q 'Waiting on'

          # Generate a JavaScript bundle. Allows the app to request a bundle from
          # the cache instead of generating one from scratch. This minimises the
          # risk of test failure due to assertions timing out while waiting for
          # the bundle to load. The URL was determined by inspecting the sources
          # via the Dev Tools.
          curl 'http://localhost:8081/index.bundle?platform=android&dev=true&lazy=true&minify=false&app=co.hibi.app.test&modulesOnly=false&runModule=true&excludeSource=true&sourcePaths=url-server&transform.routerRoot=src%2Fapp&transform.reactCompiler=true&transform.engine=hermes&transform.bytecode=1&unstable_transformProfile=hermes-stable' --output /dev/null

      - name: ðŸ§ª Run tests
        id: tests
        uses: ./.github/actions/launch-android-emulator
        with:
          # Android API level 32 and increased disk, heap, and RAM size seems to
          # reduce test failures due to emulator problems.
          api-level: 32
          arch: ${{ needs.build.outputs.architecture }}
          disk-size: 4096M
          heap-size: 1024M
          ram-size: 8192M

          # Base Android image is faster than Android images with Google Play
          target: default

          script: |
            adb logcat -v time > ${{ env.emulator-log-location }} &
            adb install ${{ env.app-directory }}/${{ env.app-name }}
            yarn run test:end-to-end ${{ matrix.shard }}

      - name: ðŸ’¾ Save emulator logs
        if: always() && (runner.debug || steps.tests.outcome == 'failure')
        uses: actions/upload-artifact@v4
        with:
          name: test-android-${{ matrix.shard }}-emulator-logs
          path: ${{ env.emulator-log-location }}
          if-no-files-found: 'error'

      - name: ðŸ’¾ Save test logs
        if: always() && (runner.debug || steps.tests.outcome == 'failure')
        uses: actions/upload-artifact@v4
        with:
          name: test-android-${{ matrix.shard }}-test-logs
          path: ~/.maestro/tests
          include-hidden-files: true
          if-no-files-found: 'error'
