name: android

on:
  workflow_call:
    inputs:
      build:
        required: false
        default: true
        type: boolean
      test-artifact-workflow-run-id:
        required: false
        type: number
      test-shards:
        required: true
        type: string

permissions:
  actions: write
  contents: read

env:
  architecture: x86_64
  artifact-name: build-android

jobs:
  build:
    runs-on: ubuntu-latest

    if: inputs.build == true

    steps:
      - name: ðŸ‘€ Checkout
        uses: actions/checkout@v4

      # Fixes build failures due to running out of disk space
      #
      # Example error:
      #
      # > Unhandled exception. System.IO.IOException: No space left on device
      - name: ðŸ§¹ Clean up disk
        uses: ./.github/actions/clean-up-disk

      - name: âš¡ï¸ Set up build cache
        id: build-cache
        uses: ./.github/actions/set-up-ccache

      - name: ðŸ—ï¸ Set up Android NDK
        id: set-up-android-ndk
        uses: ./.github/actions/set-up-android-ndk

      - name: ðŸ—ï¸ Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version-file: '.tool-versions'

      - name: ðŸ—ï¸ Set up Node.js
        uses: ./.github/actions/set-up-node-js

      - name: ðŸšš Install Node modules
        uses: ./.github/actions/install-node-modules

      - name: ðŸŒ Compile message catalogs
        run: |
          yarn run build:intl:extract-template
          yarn run build:intl:compile

      - name: ðŸ§° Prepare build
        run: yarn run expo prebuild --platform android

      # The Gradle setup action restores a cache of various Gradle files into
      # the `android/.gradle` directory. The `android` directory is generated
      # by `expo prebuild`. As a result, the Gradle setup has to happen after
      # `expo prebuild` has been run.
      - name: ðŸ—ï¸ Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}

      # Built Gradle plugins need to exist to ensure a Gradle configuration
      # cache hit. The cache restores files into `node_modules` so needs can
      # only be run after Node modules have been installed/restored.
      - name: âš¡ï¸ Set up Gradle plugins
        uses: actions/cache@v4
        with:
          key: "gradle-plugins-\
            ${{ runner.os }}-\
            ${{ runner.arch }}-\
            ${{ hashFiles('**/*gradle-plugin/**/src') }}"
          path: '**/*gradle-plugin/**/build'

      # Native dependencies need to be linked to ensure a Gradle configuration
      # cache hit. See the script file for more information.
      - name: ðŸ”— Link native dependencies
        run: ./.github/scripts/link-android-native-dependencies.sh

      # Build the Android test APK with the specified architecture and increased
      # JVM memory to avoid out-of-memory errors.
      #
      # A debug build is built because the end-to-end tests executes `run-as` in
      # the ADB shell to write fixture data, which is only possible with debug
      # builds.
      - name: ðŸ‘· Build app
        id: build
        run: |
          set -o pipefail

          ndk_version=$(yarn run build:android:test:debug \
            :properties --property ndkVersion \
            -Dorg.gradle.jvmargs='-Xmx4g -XX:MaxMetaspaceSize=1g' \
            -PreactNativeArchitectures='${{ env.architecture }}' |
          tee >(cat >&2) |
          sed -En 's/ndkVersion: ([0-9]+\.[0-9]+\.[0-9]+)/\1/Ip')

          echo "ndk_version=$ndk_version" >> $GITHUB_OUTPUT

      - name: ðŸ’¾ Save app build
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.artifact-name }}
          path: ./android/app/build/outputs/apk/endToEndTest/debug/app-endToEndTest-debug.apk
          if-no-files-found: 'error'

      - name: ðŸ’¾ Save build cache debug artifacts
        if: runner.debug
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.artifact-name }}-build-cache-debug-artifacts
          path: ${{ steps.build-cache.outputs.debug-directory }}

      - name: âš¡ï¸ Cache Android NDK
        if: steps.set-up-android-ndk.outputs.version != steps.build.outputs.ndk_version
        uses: actions/cache/save@v4
        with:
          key: android-ndk-${{ steps.build.outputs.ndk_version }}
          path: /usr/local/lib/android/sdk/ndk/${{ steps.build.outputs.ndk_version }}*

  test:
    name: test (${{ matrix.shard.name }})
    needs: [build]
    # yamllint disable-line rule:line-length
    if: always() && (inputs.build && needs.build.result == 'success') || (!inputs.build && inputs.test-artifact-workflow-run-id)
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      app-directory: ./build
      app-name: app-endToEndTest-debug.apk
      emulator-log-location: ./emulator.log

    strategy:
      # Allow other shards to run to completion to allow for the possibility of
      # them passing, reducing the amount of shards that need to be re-run.
      fail-fast: false
      matrix:
        shard: ${{ fromJson(inputs.test-shards) }}

    steps:
      - name: ðŸ‘€ Checkout
        uses: actions/checkout@v4

      # Fixes build failures due to running out of disk space
      #
      # Example error:
      #
      # > Unhandled exception. System.IO.IOException: No space left on device
      - name: ðŸ§¹ Clean up disk
        uses: ./.github/actions/clean-up-disk

      - name: ðŸ—ï¸ Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: '.tool-versions'

      - name: ðŸ—ï¸ Set up Node.js
        uses: ./.github/actions/set-up-node-js

      - name: ðŸ—ï¸ Set up Maestro
        uses: ./.github/actions/set-up-maestro
        with:
          maestro-version: 1.41.0

      - name: ðŸšš Install Node modules
        uses: ./.github/actions/install-node-modules

      - name: ðŸ“¥ Download app build
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.artifact-name }}
          path: ${{ env.app-directory }}
          github-token: ${{ github.token }}
          run-id: ${{ inputs.build && github.run_id || inputs.test-artifact-workflow-run-id }}

      - name: ðŸŒ Compile message catalogs
        run: |
          yarn run build:intl:extract-template
          yarn run build:intl:compile

      # Speeds up tests
      - name: ðŸŽï¸ Enable hardware acceleration
        run: ./.github/scripts/enable-hardware-acceleration.sh

      - name: ðŸ—„ï¸ Start JavaScript bundle server
        env:
          EXPO_PUBLIC_TELEMETRY_DSN: http://spotlight@localhost:8969/0
        run: ./.github/scripts/start-android-test-javascript-bundle-server.sh

      - name: ðŸ§ª Run tests
        id: tests
        uses: ./.github/actions/launch-android-emulator
        with:
          # Android API level 32 and increased disk, heap, and RAM size seems to
          # reduce test failures due to emulator problems.
          api-level: 32
          arch: ${{ env.architecture }}
          disk-size: 4096M
          heap-size: 1024M
          ram-size: 8192M

          # Base Android image is faster than Android images with Google Play
          target: default

          script: |
            adb logcat -v time > ${{ env.emulator-log-location }} &
            adb install ${{ env.app-directory }}/${{ env.app-name }}
            yarn run test:end-to-end ${{ matrix.shard.tests }}

      - name: ðŸ’¾ Save emulator logs
        if: always() && (runner.debug || steps.tests.outcome == 'failure')
        uses: actions/upload-artifact@v4
        with:
          name: test-android-${{ matrix.shard.name }}-emulator-logs
          path: ${{ env.emulator-log-location }}
          if-no-files-found: 'error'

      - name: ðŸ’¾ Save test logs
        if: always() && (runner.debug || steps.tests.outcome == 'failure')
        uses: actions/upload-artifact@v4
        with:
          name: test-android-${{ matrix.shard.name }}-test-logs
          path: ~/.maestro/tests
          include-hidden-files: true
          if-no-files-found: 'error'
