name: ios

on:
  workflow_call:
    inputs:
      build:
        required: false
        default: true
        type: boolean
      test-artifact-workflow-run-id:
        required: false
        type: number
      test-shards:
        required: true
        type: string

permissions:
  actions: write
  contents: read

env:
  UPDATES_URL: 'http://localhost:8800/manifest'
  artifact-name: build-ios

jobs:
  build:
    runs-on: macos-15

    if: inputs.build == true

    outputs:
      artifact-name: ${{ env.artifact-name }}

    steps:
      - name: ğŸ‘€ Checkout
        uses: actions/checkout@v4

      - name: âš¡ï¸ Set up build cache
        id: build-cache
        uses: ./.github/actions/set-up-ccache
        with:
          # yamllint disable-line rule:line-length
          # Values from https://github.com/facebook/react-native/blob/5936f29d6ae95ebdd217f7f89d1e77ae4e6e5294/packages/react-native/scripts/xcode/ccache.conf
          depend-mode: true
          file-clone: true
          inode-cache: true
          sloppiness: "clang_index_store,\
            file_stat_matches,\
            include_file_ctime,\
            include_file_mtime,\
            ivfsoverlay,\
            pch_defines,\
            modules,\
            system_headers,\
            time_macros"

      - name: ğŸ—ï¸ Set up Node.js
        uses: ./.github/actions/set-up-node-js

      - name: ğŸ—ï¸ Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: ğŸšš Install Node modules
        uses: ./.github/actions/install-node-modules

      - name: ğŸŒ Compile message catalogs
        run: |
          yarn run build:intl:extract-template
          yarn run build:intl:compile

      - name: ğŸ§° Prepare build
        run: yarn run expo prebuild --no-install --platform ios

      - name: ğŸšš Install Pods
        uses: ./.github/actions/install-pods

      - name: ğŸ‘· Build app
        run: yarn run build:ios:test:release

      - name: ğŸ’¾ Save app build
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.artifact-name }}
          path: ./ios/build/Build/Products/Test-Release-iphonesimulator/Hibi.app
          if-no-files-found: 'error'

      - name: ğŸ’¾ Save build cache debug artifacts
        if: runner.debug
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.artifact-name }}-build-cache-debug-artifacts
          path: ${{ steps.build-cache.outputs.debug-directory }}

  test:
    name: test (${{ matrix.shard.name }})
    needs: [build]
    # yamllint disable-line rule:line-length
    if: always() && (inputs.build && needs.build.result == 'success') || (!inputs.build && inputs.test-artifact-workflow-run-id)
    runs-on: macos-14
    timeout-minutes: 60

    env:
      app-directory: ./build
      app-name: Hibi.app
      simulator-log-location: simulator.logarchive

    strategy:
      # Allow other shards to run to completion to allow for the possibility of
      # them passing, reducing the amount of shards that need to be re-run.
      fail-fast: false

      matrix:
        shard: ${{ fromJson(inputs.test-shards) }}

    steps:
      - name: ğŸ‘€ Checkout
        uses: actions/checkout@v4

      # The GitHub macOS runner's version of Bash is 3.x ([reference][1]). Some
      # scripts require features from Bash >=4. This step upgrades Bash.
      #
      # yamllint disable-line rule:line-length
      # [1]: https://github.com/actions/runner-images/blob/76fc2ceabfd74abd4afd113b77b22e82e23d5221/images/macos/macos-14-arm64-Readme.md?plain=1#L16
      - name: ğŸ—ï¸ Set up Bash
        run: brew install bash

      - name: ğŸ—ï¸ Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: '.tool-versions'

      - name: ğŸ—ï¸ Set up Node.js
        uses: ./.github/actions/set-up-node-js

      - name: ğŸ—ï¸ Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 15.0.1

      - name: ğŸ—ï¸ Set up Maestro
        uses: ./.github/actions/set-up-maestro
        with:
          # Maestro versions >1.39.13 seem to have issues on iOS.
          # See https://github.com/mobile-dev-inc/Maestro/issues/2610.
          maestro-version: 1.39.13

      - name: ğŸšš Install Node modules
        uses: ./.github/actions/install-node-modules

      - name: ğŸ“¥ Download app build
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.artifact-name }}
          path: ${{ env.app-directory }}/${{ env.app-name }}
          github-token: ${{ github.token }}
          run-id: ${{ inputs.build && github.run_id || inputs.test-artifact-workflow-run-id }}

      - name: ğŸ“± Launch iOS simulator
        id: launch-ios-simulator
        uses: ./.github/actions/launch-ios-simulator
        with:
          model: 'iPhone 15'
          os: 'iOS'
          os-version: 17.0

      - name: ğŸ“² Install app
        run: xcrun simctl install booted ${{ env.app-directory }}/${{ env.app-name }}

      - name: ğŸ§³ Create update bundle
        if: ${{ !inputs.build }}
        uses: ./.github/actions/create-update-bundle
        with:
          app: ${{ env.app-directory }}/${{ env.app-name }}

      - name: ğŸ§ª Run tests
        id: tests
        # Allow step to automatically retry to minimise failures due to test
        # flakiness.
        uses: nick-fields/retry@v3
        env:
          # Reduces tests failures due to the Maestro driver startup timing out.
          # 10 minutes seems to be sufficient. The default is 2 minutes, see the
          # following locations in Maestro's source:
          #
          # yamllint disable rule:line-length
          # 1. https://github.com/mobile-dev-inc/Maestro/blob/f8d58ebbc999f0ffe6fcd3d5caf2c78c91d99980/maestro-ios-driver/src/main/kotlin/xcuitest/installer/LocalXCTestInstaller.kt#L135-L137
          # 2. https://github.com/mobile-dev-inc/Maestro/blob/f8d58ebbc999f0ffe6fcd3d5caf2c78c91d99980/maestro-ios-driver/src/main/kotlin/xcuitest/installer/LocalXCTestInstaller.kt#L260
          # yamllint enable rule:line-length
          MAESTRO_DRIVER_STARTUP_TIMEOUT: 600000
        with:
          command: yarn run test:end-to-end ${{ matrix.shard.tests }}
          max_attempts: 3
          timeout_minutes: 30

      - name: ğŸ“ Capture simulator logs
        if: always() && (runner.debug || steps.tests.outcome == 'failure')
        run: xcrun simctl spawn booted log collect --output $PWD/${{ env.simulator-log-location }}

      - name: ğŸ’¾ Save simulator logs
        if: always() && (runner.debug || steps.tests.outcome == 'failure')
        uses: actions/upload-artifact@v4
        with:
          name: test-ios-${{ matrix.shard.name }}-simulator.logarchive
          path: ./${{ env.simulator-log-location }}
          if-no-files-found: 'error'

      - name: ğŸ’¾ Save test logs
        if: always() && (runner.debug || steps.tests.outcome == 'failure')
        uses: actions/upload-artifact@v4
        with:
          name: test-ios-${{ matrix.shard.name }}-test-logs
          path: ~/.maestro/tests
          include-hidden-files: true
          if-no-files-found: 'error'
