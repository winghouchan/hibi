name: check

on:
  pull_request:
    branches:
      - main
    paths-ignore: &ignore-paths
      - '**.md'
      - '.github/dependabot.y?(a)ml'
      - '.storybook/**'
      - '.env.*'
      - '.gitignore'
      - Brewfile
      - CODEOWNERS
      - LICENSE
    types: [opened, reopened, synchronize]

  push:
    branches:
      - '**'
    paths-ignore: *ignore-paths

  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

permissions:
  actions: write
  contents: read

jobs:
  plan:
    runs-on: ubuntu-latest

    env:
      number-of-shards: 5

    outputs:
      native: ${{ steps.filter.outputs.native }}
      source: ${{ steps.filter.outputs.source }}
      test-shards: ${{ steps.shard-e2e-tests.outputs.shards }}

    steps:
      - name: 👀 Checkout
        uses: actions/checkout@v4

      - name: 🧑‍✈️ Determine jobs to run
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: ./.github/path-filters.yaml

      # Shard end-to-end tests to reduce the overall run time by running tests
      # across multiple runners in parallel. Also reduces the run time for
      # re-runs as only the tests in the failing shard need to be re-run as
      # opposed to the whole suite.
      - name: ✂️ Determine end-to-end test shards
        id: shard-e2e-tests
        working-directory: e2e/tests
        run: |
          ${{ github.workspace }}/.github/scripts/shard-e2e-tests.sh \
            --group ${{ env.number-of-shards }}

  source:
    needs: [plan]
    if: needs.plan.outputs.source == 'true'
    uses: ./.github/workflows/source.yaml
    secrets: inherit

  android:
    needs: [plan]
    if: needs.plan.outputs.native == 'true'
    uses: ./.github/workflows/android.yaml
    with:
      test-shards: ${{ needs.plan.outputs.test-shards }}
    secrets: inherit

  ios:
    needs: [plan]
    if: needs.plan.outputs.native == 'true'
    uses: ./.github/workflows/ios.yaml
    with:
      test-shards: ${{ needs.plan.outputs.test-shards }}
    secrets: inherit
